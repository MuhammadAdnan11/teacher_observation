<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher Observation Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f9f9f9; margin: 0; padding: 0; }
    h2, h3 { text-align: center; color: #333; margin-top: 10px; }
    .container {
      max-width: 1000px;
      margin: 30px auto;
      padding: 20px 30px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }
    form { display: flex; flex-direction: column; gap: 20px; }
    .details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    input[type="text"], input[type="date"], input[type="time"], select, textarea {
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #1976d2;
      outline: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }
    th { background-color: #1976d2; color: white; }
    td input[type="radio"] { margin: 0 4px; }
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover { background-color: #125aa3; }
    .total-score {
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      background: #e3f2fd;
      padding: 10px;
      border-radius: 6px;
      color: #1976d2;
    }
  </style>
  <script>
    if (!localStorage.getItem("loggedInAdmin")) {
      window.location.href = "login.html";
    }
  </script>
</head>
<body>
  <nav style="background-color: #1976d2; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <img src="logo.jpg" alt="GIMS Logo" style="height: 50px; border-radius: 50%;">
      <span style="color: white; font-size: 20px; font-weight: bold;">GIMS Peshawar</span>
    </div>
    <div id="navbar-links" style="display: flex; align-items: center; gap: 20px;">
      <a href="index.html">Home</a>
      <a href="records.html">Records</a>
      <button onclick="logout()" style="background: #ffffff; color: #1976d2; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 500;">Logout</button>
    </div>
  </nav>

  <div class="container" id="formContainer">
    <h2>Ghazzali Institute of Medical Sciences Peshawar</h2>
    <h3>Teacher Lecture Observation Form</h3>

    <form id="evaluationForm">
      <div class="details">
        <select id="campusDropdown" required>
          <option value="">Select Campus</option>
          <option>Main Campus</option>
          <option>Phase-3 Campus</option>
          <option>Gulabad Campus</option>
        </select>
        <select id="teacherTypeDropdown" required disabled>
          <option value="">Select Teacher Type</option>
        </select>
        <select id="teacherDropdown" required disabled>
          <option value="">Select Teacher</option>
        </select>
        <select id="subjectDropdown" required disabled>
          <option value="">Select Subject</option>
        </select>
        <input type="text" id="teacherID" placeholder="Teacher ID" disabled />
        <input type="text" id="topic" placeholder="Topic of Demo" />
        <input type="text" id="length" placeholder="Length of Demo" />
        <input type="text" id="conducted" placeholder="Conducted by" />
        <input type="date" id="date" />
        <input type="time" id="time" />
      </div>

      <p><strong>Rating Key:</strong> 1=Unsatisfactory, 2=Fair, 3=Satisfactory, 4=Very Good, 5=Excellent</p>

      <table>
        <thead>
          <tr>
            <th>Attribute</th>
            <th>Rating</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="criteriaTable"></tbody>
      </table>

      <textarea id="additionalComments" placeholder="Additional Comments"></textarea>

      <div class="total-score" id="totalScore">Total Score: 0 | Average: 0</div>

      <div class="btn-group">
        <button type="submit">Save</button>
        <button type="button" onclick="printForm()">Print</button>
        <button type="button" onclick="downloadPDF()">Download PDF</button>
      </div>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    const criteria = JSON.parse(localStorage.getItem("evaluationCriteria") || "[]");
    const tableBody = document.getElementById("criteriaTable");

    criteria.forEach((item, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item}</td>
        <td>${[1,2,3,4,5].map(i => `<label><input type="radio" name="rating-${index}" value="${i}" required> ${i}</label>`).join(" ")}</td>
        <td><input type="text" placeholder="Optional" style="width:100%"></td>`;
      tableBody.appendChild(row);
    });

    function calculateScore() {
      let total = 0, count = 0;
      criteria.forEach((_, index) => {
        const checked = document.querySelector(`input[name="rating-${index}"]:checked`);
        if (checked) {
          total += parseInt(checked.value);
          count++;
        }
      });
      const avg = count ? (total / count).toFixed(2) : 0;
      document.getElementById("totalScore").textContent = `Total Score: ${total} | Average: ${avg}`;
    }
    document.addEventListener("change", calculateScore);

    const teachersData = JSON.parse(localStorage.getItem("teachers") || "{}");
    const campusDropdown = document.getElementById("campusDropdown");
    const teacherTypeDropdown = document.getElementById("teacherTypeDropdown");
    const teacherDropdown = document.getElementById("teacherDropdown");
    const subjectDropdown = document.getElementById("subjectDropdown");

    campusDropdown.addEventListener("change", function () {
      teacherTypeDropdown.innerHTML = '<option value="">Select Teacher Type</option>';
      teacherDropdown.innerHTML = '<option value="">Select Teacher</option>';
      subjectDropdown.innerHTML = '<option value="">Select Subject</option>';
      teacherTypeDropdown.disabled = teacherDropdown.disabled = subjectDropdown.disabled = true;

      const campus = this.value;
      if (campus && teachersData[campus]) {
        Object.keys(teachersData[campus]).forEach(type => {
          const opt = document.createElement("option");
          opt.value = type;
          opt.textContent = type;
          teacherTypeDropdown.appendChild(opt);
        });
        teacherTypeDropdown.disabled = false;
      }
    });

    teacherTypeDropdown.addEventListener("change", function () {
      teacherDropdown.innerHTML = '<option value="">Select Teacher</option>';
      subjectDropdown.innerHTML = '<option value="">Select Subject</option>';
      teacherDropdown.disabled = subjectDropdown.disabled = true;

      const campus = campusDropdown.value;
      const type = this.value;
      if (campus && type && teachersData[campus][type]) {
        teachersData[campus][type].forEach(teacher => {
          const opt = document.createElement("option");
          opt.value = teacher.id;
          opt.textContent = teacher.name;
          teacherDropdown.appendChild(opt);
        });
        teacherDropdown.disabled = false;
      }
    });

    teacherDropdown.addEventListener("change", function () {
      subjectDropdown.innerHTML = '<option value="">Select Subject</option>';
      subjectDropdown.disabled = true;

      const campus = campusDropdown.value;
      const type = teacherTypeDropdown.value;
      const teacherID = this.value;
      const teacher = teachersData[campus][type].find(t => t.id === teacherID);

      if (teacher) {
        document.getElementById("teacherID").value = teacher.id;
       if (teacher.subject) {
  const opt = document.createElement("option");
  opt.value = teacher.subject;
  opt.textContent = teacher.subject;
  subjectDropdown.appendChild(opt);
  subjectDropdown.disabled = false;
}

      }
    });

    document.getElementById("evaluationForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const entries = {};
      formData.forEach((v,k)=> entries[k]=v);
      entries.totalScore = document.getElementById("totalScore").textContent;
      entries.teacherID = document.getElementById("teacherID").value;
      entries.subject = document.getElementById("subjectDropdown").value;
      entries.date = document.getElementById("date").value;

      const records = JSON.parse(localStorage.getItem("teacherEvaluations") || "[]");
      records.push(entries);
      localStorage.setItem("teacherEvaluations", JSON.stringify(records));
      alert("Form saved successfully!");
    });

    function printForm() { window.print(); }
    function downloadPDF() { html2pdf().from(document.getElementById("formContainer")).save("Teacher-Evaluation.pdf"); }

    function logout(){
      localStorage.removeItem("loggedInAdmin");
      localStorage.removeItem("adminRole");
      window.location.href = "login.html";
    }

    document.addEventListener("DOMContentLoaded", function(){
      if(localStorage.getItem("adminRole")==="supervisor"){
        const l = document.createElement("a");
        l.href="admin.html";
        l.textContent="Admin";
        l.style.color="white";
        document.getElementById("navbar-links").appendChild(l);
      }
    });
  </script>
</body>
</html>
